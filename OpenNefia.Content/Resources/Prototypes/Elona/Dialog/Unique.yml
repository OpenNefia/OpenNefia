---
- type: Elona.Dialog
  id: Elona.PartTimeWorker
- type: Elona.Dialog
  id: Elona.Pael
- type: Elona.Dialog
  id: Elona.Orphe
- type: Elona.Dialog
  id: Elona.Poppy
- type: Elona.Dialog
  id: Elona.Renton
- type: Elona.Dialog
  id: Elona.Raphael
- type: Elona.Dialog
  id: Elona.Rilian
- type: Elona.Dialog
  id: Elona.RogueBoss
- type: Elona.Dialog
  id: Elona.Noel
- type: Elona.Dialog
  id: Elona.Miches

- type: Elona.Dialog
  id: Elona.Lomias
  scriptImports:
  - OpenNefia.Content.Prototypes
  - OpenNefia.Content.Items
  - OpenNefia.Content.Identify
  - OpenNefia.Content.CurseStates
  - OpenNefia.Content.UI
  - OpenNefia.Content.VanillaAI
  - OpenNefia.Content.Chests
  scriptDependencies:
    _gameSession: OpenNefia.Core.Game.IGameSessionManager
    _entityManager: OpenNefia.Core.GameObjects.IEntityManager
    _sidequests: OpenNefia.Content.Sidequests.ISidequestSystem
    _charaGen: OpenNefia.Content.RandomGen.ICharaGen
    _itemGen: OpenNefia.Content.RandomGen.IItemGen
    _mes: OpenNefia.Content.Logic.IMessagesManager
  nodes:
    __start__: !type:DialogBranchNode
      conditions:
      - condition: !type:SidequestStateCondition
          sidequestID: Elona.Tutorial
        value: 0
        node: Elona.Lomias:Tutorial0
      - condition: !type:SidequestStateCondition
          sidequestID: Elona.Tutorial
        value: 1
        node: Elona.Lomias:Tutorial1
      - condition: !type:SidequestStateCondition
          sidequestID: Elona.Tutorial
        value: 2
        node: Elona.Lomias:Tutorial2
      - condition: !type:SidequestStateCondition
          sidequestID: Elona.Tutorial
        value: 3
        node: Elona.Lomias:Tutorial3
      - condition: !type:SidequestStateCondition
          sidequestID: Elona.Tutorial
        value: 4
        node: Elona.Lomias:Tutorial4
      - condition: !type:SidequestStateCondition
          sidequestID: Elona.Tutorial
        value: 5
        node: Elona.Lomias:Tutorial5
      - condition: !type:SidequestStateCondition
          sidequestID: Elona.Tutorial
        value: 6
        node: Elona.Lomias:Tutorial6
      - condition: !type:SidequestStateCondition
          sidequestID: Elona.Tutorial
        value: 7
        node: Elona.Lomias:Tutorial7
      - condition: !type:SidequestStateCondition
          sidequestID: Elona.Tutorial
        value: 8
        node: Elona.Lomias:Tutorial8
      - condition: !type:SidequestStateCondition
          sidequestID: Elona.Tutorial
        value: 99
        node: Elona.Lomias:Tutorial99
      - condition: !type:SidequestStateCondition
          sidequestID: Elona.Tutorial
        value: -1
        node: Elona.Lomias:TutorialAfter

    Tutorial0: !type:DialogTextNode
      texts:
      - Elona.Dialog.Unique.Lomias.Tutorial0.Text
      choices:
      - text: Elona.Dialog.Unique.Lomias.Tutorial0.Choices.Yes
        nextNode: Elona.Lomias:Tutorial0_Start
      - text: Elona.Dialog.Unique.Lomias.Tutorial0.Choices.No
        isDefault: true
      - text: Elona.Dialog.Unique.Lomias.TutorialAfter.Choices.GetOut
        nextNode: Elona.Lomias:GetOut
    Tutorial0_Start: !type:DialogTextNode
      texts:
      - Elona.Dialog.Unique.Lomias.Tutorial0_Start.Text
      choices:
      - text: Elona.Dialog.Common.Choices.More
        nextNode: Elona.Lomias:__start__
      afterEnter: |
        var corpse = _itemGen.GenerateItem(_gameSession.Player, Protos.Item.Corpse);
        if (_entityManager.IsAlive(corpse))
        {
            var protoSource = _entityManager.EnsureComponent<EntityProtoSourceComponent>(corpse.Value);
            protoSource.EntityID = Protos.Chara.Beggar;
            _entityManager.EnsureComponent<IdentifyComponent>(corpse.Value).IdentifyState = IdentifyState.Full;
            _mes.Display(Loc.GetString("Elona.Common.SomethingIsPut"));
        }
        _sidequests.SetState(Protos.Sidequest.Tutorial, 1);

    Tutorial1: !type:DialogTextNode
      texts:
      - Elona.Dialog.Unique.Lomias.Tutorial1.Text
      choices:
      - text: Elona.Dialog.Unique.Lomias.Tutorial1.Choices.Alright
        isDefault: true
      - text: Elona.Dialog.Unique.Lomias.Tutorial1.Choices.Ate
        nextNode: Elona.Lomias:Tutorial1_Ate1
    Tutorial1_Ate1: !type:DialogTextNode
      texts:
      - Elona.Dialog.Unique.Lomias.Tutorial1_Ate1.Text
      choices:
      - text: Elona.Dialog.Unique.Lomias.Tutorial1_Ate1.Choices.What
        nextNode: Elona.Lomias:Tutorial1_Ate2
    Tutorial1_Ate2: !type:DialogTextNode
      texts:
      - Elona.Dialog.Unique.Lomias.Tutorial1_Ate2.Text
      choices:
      - text: Elona.Dialog.Common.Choices.More
        nextNode: Elona.Lomias:__start__
      afterEnter: |
        _sidequests.SetState(Protos.Sidequest.Tutorial, 2);

    Tutorial2: !type:DialogTextNode
      texts:
      - Elona.Dialog.Unique.Lomias.Tutorial2.Text
      choices:
      - text: Elona.Dialog.Unique.Lomias.Tutorial2.Choices.Okay
        isDefault: true

    Tutorial3: !type:DialogTextNode
      beforeEnter: |
        var scroll = _itemGen.GenerateItem(_gameSession.Player, Protos.Item.ScrollOfIdentify);
        if (_entityManager.IsAlive(scroll))
        {
            _mes.Display(Loc.GetString("Elona.Common.SomethingIsPut"));
            _entityManager.EnsureComponent<IdentifyComponent>(scroll.Value).IdentifyState = IdentifyState.Full;
        }
      texts:
      - Elona.Dialog.Unique.Lomias.Tutorial3.Text
      choices:
      - text: Elona.Dialog.Common.Choices.More
        nextNode: Elona.Lomias:__start__
      afterEnter: |
        _sidequests.SetState(Protos.Sidequest.Tutorial, 4);

    Tutorial4: !type:DialogTextNode
      texts:
      - Elona.Dialog.Unique.Lomias.Tutorial4.Text
      choices:
      - text: Elona.Dialog.Unique.Lomias.Tutorial4.Choices.Alright
        isDefault: true
      - text: Elona.Dialog.Unique.Lomias.Tutorial4.Choices.Done
        nextNode: Elona.Lomias:Tutorial4_IdentifyDone
    Tutorial4_IdentifyDone: !type:DialogTextNode
      texts:
      - Elona.Dialog.Unique.Lomias.Tutorial4_IdentifyDone.Text
      choices:
      - text: Elona.Dialog.Common.Choices.More
        nextNode: Elona.Lomias:__start__
      afterEnter: |
        var item = _itemGen.GenerateItem(_gameSession.Player, Protos.Item.LongBow);
        if (_entityManager.IsAlive(item))
        {
            _entityManager.EnsureComponent<CurseStateComponent>(item.Value).CurseState = CurseState.Cursed;
        }

        item = _itemGen.GenerateItem(_gameSession.Player, Protos.Item.Arrow);
        if (_entityManager.IsAlive(item))
        {
            _entityManager.EnsureComponent<CurseStateComponent>(item.Value).CurseState = CurseState.Normal;
        }

        item = _itemGen.GenerateItem(_gameSession.Player, Protos.Item.ScrollOfVanishCurse);
        if (_entityManager.IsAlive(item))
        {
            _entityManager.EnsureComponent<IdentifyComponent>(item.Value).IdentifyState = IdentifyState.Full;
            _entityManager.EnsureComponent<CurseStateComponent>(item.Value).CurseState = CurseState.Blessed;
        }

        _mes.Display(Loc.GetString("Elona.Common.SomethingIsPut"));
        _sidequests.SetState(Protos.Sidequest.Tutorial, 5);

    Tutorial5: !type:DialogTextNode
      texts:
      - Elona.Dialog.Unique.Lomias.Tutorial5.Text
      choices:
      - text: Elona.Dialog.Unique.Lomias.Tutorial5.Choices.Alright
        isDefault: true
      - text: Elona.Dialog.Unique.Lomias.Tutorial5.Choices.Done
        nextNode: Elona.Lomias:Tutorial5_EquipDone
    Tutorial5_EquipDone: !type:DialogTextNode
      texts:
      - Elona.Dialog.Unique.Lomias.Tutorial5_EquipDone.Text
      choices:
      - text: Elona.Dialog.Common.Choices.More
      afterEnter: |
        _mes.Display(Loc.GetString("Elona.Dialog.Unique.Lomias.Tutorial5_EquipDone.LomiasReleasesPutits"), UiColors.MesSkyBlue);

        for (var i = 0; i < 3; i++)
        {
            var putit = _charaGen.GenerateChara(_gameSession.Player, Protos.Chara.Putit);
            if (_entityManager.IsAlive(putit))
            {
                _entityManager.EnsureComponent<AINoTargetComponent>(putit.Value);
                _entityManager.EnsureComponent<TagComponent>(putit.Value).AddTag(Protos.Tag.TutorialPutit);
            }
        }

        var item = _itemGen.GenerateItem(_gameSession.Player, Protos.Item.PotionOfCureMinorWound);
        if (_entityManager.IsAlive(item))
        {
            _entityManager.EnsureComponent<IdentifyComponent>(item.Value).IdentifyState = IdentifyState.Full;
        }

        _sidequests.SetState(Protos.Sidequest.Tutorial, 6);

    Tutorial6: !type:DialogBranchNode
      conditions:
      - condition: !type:FindEntitiesWithTagCondition
          tag: Elona.TutorialPutit
        comparison: GreaterThan
        value: 0
        node: Elona.Lomias:Tutorial6_PutitsRemaining
      defaultNode: Elona.Lomias:Tutorial6_Finished
    Tutorial6_PutitsRemaining: !type:DialogTextNode
      texts:
      - Elona.Dialog.Unique.Lomias.Tutorial6_PutitsRemaining.Text
    Tutorial6_Finished: !type:DialogTextNode
      texts:
      - Elona.Dialog.Unique.Lomias.Tutorial6_Finished.Text
      choices:
      - text: Elona.Dialog.Common.Choices.More
        nextNode: Elona.Lomias:__start__
      afterEnter: |
        _sidequests.SetState(Protos.Sidequest.Tutorial, 7);

    Tutorial7: !type:DialogTextNode
      texts:
      - Elona.Dialog.Unique.Lomias.Tutorial7.Text
      choices:
      - text: Elona.Dialog.Common.Choices.More
        nextNode: Elona.Lomias:Tutorial7_Chest
    Tutorial7_Chest: !type:DialogTextNode
      beforeEnter: |
        var chest = _itemGen.GenerateItem(_gameSession.Player, Protos.Item.Chest);
        if (_entityManager.IsAlive(chest) && _entityManager.TryGetComponent<ChestComponent>(chest.Value, out var chestComp))
        {
            chestComp.ItemLevel = 35;
            chestComp.LockpickDifficulty = 25;
        }
        _itemGen.GenerateItem(_gameSession.Player, Protos.Item.Lockpick, amount: 2);
        _mes.Display(Loc.GetString("Elona.Common.SomethingIsPut"));
      texts:
      - Elona.Dialog.Unique.Lomias.Tutorial7_Chest.Text
      afterEnter: |
        _sidequests.SetState(Protos.Sidequest.Tutorial, 8);

    Tutorial8: !type:DialogTextNode
      texts:
      - Elona.Dialog.Unique.Lomias.Tutorial8.Text
      choices:
      - text: Elona.Dialog.Common.Choices.More
        nextNode: Elona.Lomias:__start__
      afterEnter: |
        _sidequests.SetState(Protos.Sidequest.Tutorial, 99);

    Tutorial99: !type:DialogTextNode
      texts:
      - Elona.Dialog.Unique.Lomias.Tutorial99.Text
      afterEnter: |
        _sidequests.SetState(Protos.Sidequest.Tutorial, -1);

    TutorialAfter: !type:DialogTextNode
      texts:
      - Elona.Dialog.Unique.Lomias.TutorialAfter.Text
      choices:
      - text: Elona.Dialog.Unique.Lomias.TutorialAfter.Choices.Nothing
        isDefault: true
      - text: Elona.Dialog.Unique.Lomias.TutorialAfter.Choices.GetOut
        nextNode: Elona.Lomias:GetOut

    GetOut: !type:DialogTextNode
      texts:
      - Elona.Dialog.Common.IsSleeping

    # GetOut: !type:DialogBranchNode
    #   conditions:
    #   - condition: !type:FindEntitiesWithPrototypeCondition
    #       protoID: Elona.CharaLarnneire
    #     value: 0
    #     node: Elona.Lomias:GetOut_LarnneireDied
    #   defaultNode: Elona.Lomias:GetOut_Execute
    # GetOut_LarnneireDied: !type:DialogTextNode
    # GetOut_Execute: !type:DialogTextNode

- type: Elona.Dialog
  id: Elona.LomiasNewGame
  nodes:
    __start__: !type:DialogJumpNode
      nextNode: Elona.Lomias:__start__

- type: Elona.Dialog
  id: Elona.Miral
- type: Elona.Dialog
  id: Elona.Loyter
- type: Elona.Dialog
  id: Elona.Mia
- type: Elona.Dialog
  id: Elona.Marks
- type: Elona.Dialog
  id: Elona.Lily
- type: Elona.Dialog
  id: Elona.Shena
- type: Elona.Dialog
  id: Elona.Stersha
- type: Elona.Dialog
  id: Elona.QuestHarvest
- type: Elona.Dialog
  id: Elona.QuestEscort
- type: Elona.Dialog
  id: Elona.QuestDeliver
- type: Elona.Dialog
  id: Elona.QuestHuntex
- type: Elona.Dialog
  id: Elona.QuestParty
- type: Elona.Dialog
  id: Elona.QuestHunt
- type: Elona.Dialog
  id: Elona.Slan
- type: Elona.Dialog
  id: Elona.QuestCook
- type: Elona.Dialog
  id: Elona.QuestCollect
- type: Elona.Dialog
  id: Elona.Tam
- type: Elona.Dialog
  id: Elona.StrangeScientist
- type: Elona.Dialog
  id: Elona.QuestConquer
- type: Elona.Dialog
  id: Elona.WhomDwellInTheVanity
- type: Elona.Dialog
  id: Elona.Zeome
- type: Elona.Dialog
  id: Elona.Xabi
- type: Elona.Dialog
  id: Elona.QuestSupply
- type: Elona.Dialog
  id: Elona.Lexus
- type: Elona.Dialog
  id: Elona.Karam
- type: Elona.Dialog
  id: Elona.Larnneire
- type: Elona.Dialog
  id: Elona.GuestCitizen
- type: Elona.Dialog
  id: Elona.GuestBeggar
- type: Elona.Dialog
  id: Elona.Garokk
- type: Elona.Dialog
  id: Elona.Erystia
- type: Elona.Dialog
  id: Elona.Doria
- type: Elona.Dialog
  id: Elona.Gilbert
- type: Elona.Dialog
  id: Elona.KanedaBike
- type: Elona.Dialog
  id: Elona.Icolle
- type: Elona.Dialog
  id: Elona.GuestTrainer
- type: Elona.Dialog
  id: Elona.Conery
- type: Elona.Dialog
  id: Elona.Arnord
- type: Elona.Dialog
  id: Elona.GuestProducer
- type: Elona.Dialog
  id: Elona.GuestPunk
- type: Elona.Dialog
  id: Elona.Balzak
- type: Elona.Dialog
  id: Elona.GuestMerchant
- type: Elona.Dialog
  id: Elona.Ainc
- type: Elona.Dialog
  id: Elona.Abyss
- type: Elona.Dialog
  id: Elona.WanderingMerchant
...
